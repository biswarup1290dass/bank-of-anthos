version: 2.1

executors:
  docker-executor:
    docker:
      - image: cimg/base:stable

jobs:
  build-and-push:
    parameters:
      service:
        type: string
    executor: docker-executor
    steps:
      - checkout

      # Install Skaffold for services that use it
      - run:
          name: Install Skaffold
          command: |
            curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
            chmod +x skaffold
            sudo mv skaffold /usr/local/bin/

      - run:
          name: Set build path
          command: |
            case "<< parameters.service >>" in
              accounts-db) BUILD_PATH="src/accounts/accounts-db" ;;
              contacts) BUILD_PATH="src/accounts/contacts" ;;
              userservice) BUILD_PATH="src/accounts/userservice" ;;
              frontend) BUILD_PATH="src/frontend" ;;
              balancereader) BUILD_PATH="src/ledger/balancereader" ;;
              ledgerwriter) BUILD_PATH="src/ledger/ledgerwriter" ;;
              transactionhistory) BUILD_PATH="src/ledger/transactionhistory" ;;
              ledger-db) BUILD_PATH="src/ledger/ledger-db" ;;
              loadgenerator) BUILD_PATH="src/loadgenerator" ;;
              *)
                echo "Unknown service: << parameters.service >>"
                exit 1
                ;;
            esac
            echo "export BUILD_PATH=$BUILD_PATH" >> $BASH_ENV

      - run:
          name: Build and push Docker image
          command: |
            IMAGE_NAME="${DOCKER_REGISTRY}/${DOCKER_ORG}/bank-of-anthos-<< parameters.service >>"

            if [ -f "$BUILD_PATH/Dockerfile" ]; then
              echo "Building Dockerfile for << parameters.service >>"
              docker build -t "$IMAGE_NAME:latest" "$BUILD_PATH"
              docker tag "$IMAGE_NAME:latest" "$IMAGE_NAME:${CIRCLE_SHA1}"
              echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin $DOCKER_REGISTRY
              docker push "$IMAGE_NAME:latest"
              docker push "$IMAGE_NAME:${CIRCLE_SHA1}"
            elif [ -f "$BUILD_PATH/skaffold.yaml" ]; then
              echo "Building via Skaffold for << parameters.service >>"
              skaffold build -f "$BUILD_PATH/skaffold.yaml" -p default --default-repo "$DOCKER_REGISTRY/$DOCKER_ORG"
            else
              echo "No Dockerfile or skaffold.yaml found for << parameters.service >>"
              exit 1
            fi

workflows:
  version: 2
  build-and-push-all:
    jobs:
      - build-and-push:
          matrix:
            parameters:
              service:
                - accounts-db
                - contacts
                - userservice
                - frontend
                - balancereader
                - ledgerwriter
                - transactionhistory
                - ledger-db
                - loadgenerator
